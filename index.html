<script>
  let allDrugs = [];
  let selectedDrugs = [];

  document.getElementById('agreeBtn').addEventListener('click', () => {
    document.getElementById('disclaimer').classList.add('hidden');
    document.getElementById('agreeBtn').classList.add('hidden');
    document.getElementById('app').classList.remove('hidden');
    document.getElementById('search').focus();
  });

  fetch('drugs.json')
    .then(res => res.json())
    .then(drugs => {
      allDrugs = drugs;
    })
    .catch(err => {
      document.getElementById('results').innerHTML = 
        `<p style="color:red">‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö: ${err.message}</p>`;
    });

  document.getElementById('search').addEventListener('input', e => {
    const q = e.target.value.trim().toLowerCase();
    if (!q) {
      document.getElementById('results').innerHTML = '<p>–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∏–ª–∏ –ú–ù–ù –¥–ª—è –ø–æ–∏—Å–∫–∞...</p>';
      document.getElementById('compareBtn').disabled = true;
      selectedDrugs = [];
      return;
    }
    const filtered = allDrugs.filter(d =>
      (d.trade_name || '').toLowerCase().includes(q) ||
      (d.mnn || '').toLowerCase().includes(q)
    );
    displayDrugs(filtered);
  });

  function displayDrugs(list) {
    const container = document.getElementById('results');
    if (list.length === 0) {
      container.innerHTML = '<p>–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</p>';
      document.getElementById('compareBtn').disabled = true;
      return;
    }

    container.innerHTML = list.map((d, idx) => 
      `<div class="drug">
        <label>
          <input type="checkbox" data-index="${idx}" onchange="toggleSelection(${idx}, this.checked)">
          <i class="fas fa-capsules"></i>
          <div>
            <strong>${d.trade_name || '‚Äî'}</strong><br>
            <small>–ú–ù–ù: ${d.mnn || '‚Äî'} ‚Ä¢ ${d.form || '‚Äî'}, ${d.dosage || ''}</small><br>
            <small>–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å: ${d.producer || '‚Äî'}</small><br>
            <small>
              <strong>–†–µ–≥. ‚Ññ:</strong> ${d.reg_number || '‚Äî'}<br>
              <a href="https://grls.rosminzdrav.ru/#!/GrlsList" target="_blank" class="grls-link">
                üîç –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤ –ì–†–õ–°
              </a>
            </small>
          </div>
        </label>
      </div>`
    ).join('');

    document.getElementById('compareBtn').disabled = true;
  }

  window.toggleSelection = function(idx, checked) {
    const drug = allDrugs[idx];
    if (checked) {
      selectedDrugs.push(drug);
    } else {
      selectedDrugs = selectedDrugs.filter(d => d !== drug);
    }
    const btn = document.getElementById('compareBtn');
    btn.disabled = !(selectedDrugs.length >= 2 && selectedDrugs.length <= 3);

    // üëá –í—Ä–µ–º–µ–Ω–Ω—ã–π –≤—ã–≤–æ–¥ –≤ –∫–æ–Ω—Å–æ–ª—å –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
    console.log('–í—ã–±—Ä–∞–Ω–Ω—ã–µ –ø—Ä–µ–ø–∞—Ä–∞—Ç—ã:', selectedDrugs.map(d => d.trade_name));
  };

  document.getElementById('compareBtn').addEventListener('click', () => {
    if (selectedDrugs.length < 2) return;

    const table = `
      <h3><i class="fas fa-balance-scale"></i> –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –∞–Ω–∞–ª–æ–≥–æ–≤</h3>
      <table>
        <thead>
          <tr>
            <th>–ü–∞—Ä–∞–º–µ—Ç—Ä</th>
            ${selectedDrugs.map(d => `<th>${d.trade_name}</th>`).join('')}
          </tr>
        </thead>
        <tbody>
          <tr><td><strong>–ú–ù–ù</strong></td>${selectedDrugs.map(d => `<td>${d.mnn || '‚Äî'}</td>`).join('')}</tr>
          <tr><td><strong>–§–æ—Ä–º–∞</strong></td>${selectedDrugs.map(d => `<td>${d.form || '‚Äî'}</td>`).join('')}</tr>
          <tr><td><strong>–î–æ–∑–∏—Ä–æ–≤–∫–∞</strong></td>${selectedDrugs.map(d => `<td>${d.dosage || '‚Äî'}</td>`).join('')}</tr>
          <tr><td><strong>–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å</strong></td>${selectedDrugs.map(d => `<td>${d.producer || '‚Äî'}</td>`).join('')}</tr>
          <tr><td><strong>–°—Ç—Ä–∞–Ω–∞</strong></td>${selectedDrugs.map(d => `<td>${d.country || '‚Äî'}</td>`).join('')}</tr>
          <tr>
            <td><strong>–†–µ–≥. ‚Ññ</strong></td>
            ${selectedDrugs.map(d => `
              <td>
                ${d.reg_number || '‚Äî'}<br>
                <a href="https://grls.rosminzdrav.ru/#!/GrlsList" target="_blank" class="grls-link" style="font-size:0.8em;">
                  üîç –ì–†–õ–°
                </a>
              </td>
            `).join('')}
          </tr>
        </tbody>
      </table>
    `;
    document.getElementById('comparison').innerHTML = table;
  });
</script>